const Airtable = require('airtable');
const { Resend } = require('resend');

const base = new Airtable({ apiKey: process.env.AIRTABLE_API_KEY })
  .base(process.env.AIRTABLE_BASE_ID);

const resend = new Resend(process.env.RESEND_API_KEY);
const SITE_URL = process.env.SITE_URL || 'https://conferix.com/usa';

function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

exports.handler = async (event) => {
  const headers = { 'Content-Type': 'application/json' };

  const params = event.queryStringParameters || {};
  if (params.key !== process.env.ALERTS_SECRET) {
    return { statusCode: 403, headers, body: JSON.stringify({ error: 'Forbidden' }) };
  }

  try {
    const today = new Date();
    const nextWeek = new Date(today);
    nextWeek.setDate(nextWeek.getDate() + 7);
    const todayStr = today.toISOString().split('T')[0];
    const nextWeekStr = nextWeek.toISOString().split('T')[0];

    const records = await base('Events').select({
      filterByFormula: `AND({start_date} >= "${todayStr}", {start_date} <= "${nextWeekStr}")`,
      sort: [{ field: 'start_date', direction: 'asc' }],
    }).all();

    const events = records.map(r => ({
      title: r.get('title'),
      start_date: r.get('start_date'),
      city: r.get('city') || '',
      industry: r.get('industry') || 'General',
    }));

    // Pick 1 event per industry
    const seen = {};
    const picks = [];
    for (const ev of events) {
      if (!seen[ev.industry]) {
        seen[ev.industry] = true;
        picks.push(ev);
      }
    }

    if (picks.length === 0) {
      return { statusCode: 200, headers, body: JSON.stringify({ message: 'No events this week' }) };
    }

    // Build LinkedIn post text
    const lines = picks.map(ev =>
      `▪ ${ev.industry} — ${ev.title} (${formatDate(ev.start_date)}, ${ev.city})`
    );

    const post = `This week's top professional events in the USA:\n\n${lines.join('\n')}\n\nBrowse all events → ${SITE_URL}\n\n#USAEvents #ProfessionalNetworking #Conferences #Conferix`;

    // Build email
    const emailHtml = `<!DOCTYPE html>
<html><head><meta charset="utf-8"></head>
<body style="margin:0;padding:0;background:#f1f5f9;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;">
  <table width="100%" cellpadding="0" cellspacing="0" style="background:#f1f5f9;padding:24px 0;">
    <tr><td align="center">
      <table width="600" cellpadding="0" cellspacing="0" style="max-width:600px;width:100%;">
        <tr><td style="background:linear-gradient(135deg,#0B1426,#1C2333);padding:24px;border-radius:12px 12px 0 0;text-align:center;">
          <p style="margin:0;font-size:20px;font-weight:700;color:#ffffff;">Conferix <span style="color:#D4A853;">USA</span></p>
          <p style="margin:8px 0 0;font-size:14px;color:#94a3b8;">LinkedIn Post Draft — Ready to Copy</p>
        </td></tr>
        <tr><td style="background:#ffffff;padding:24px;">
          <p style="margin:0 0 16px;font-size:14px;color:#64748b;">Copy the text below and paste it into LinkedIn:</p>
          <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:20px;font-size:14px;color:#0B1426;line-height:1.8;white-space:pre-wrap;">${post}</div>
          <p style="margin:16px 0 0;font-size:12px;color:#94a3b8;">Tip: Add an image of the top event for better engagement.</p>
        </td></tr>
        <tr><td style="background:#f8fafc;padding:16px;border-radius:0 0 12px 12px;text-align:center;border-top:1px solid #e2e8f0;">
          <p style="margin:0;font-size:12px;color:#94a3b8;">Auto-generated by Conferix</p>
        </td></tr>
      </table>
    </td></tr>
  </table>
</body></html>`;

    await resend.emails.send({
      from: 'Conferix USA <alerts@conferix.com>',
      to: 'tayseermbabiker@gmail.com',
      subject: `LinkedIn Draft — USA Events This Week (${formatDate(todayStr)})`,
      html: emailHtml,
    });

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({ sent: true, industries: picks.length, post }),
    };
  } catch (err) {
    console.error('LinkedIn draft error:', err);
    return { statusCode: 500, headers, body: JSON.stringify({ error: err.message }) };
  }
};
